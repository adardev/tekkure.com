<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirigiendo a la App...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #142023;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loader {
            text-align: center;
            color: white;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            margin: 2rem;
            text-align: center;
        }
        .error-message h1 {
            color: #dc2626;
            margin-bottom: 1rem;
        }
        .error-message p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        .error-message a {
            display: inline-block;
            background: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
        }
        .error-message a:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body>
    <!-- Estado de carga (se muestra mientras redirige) -->
    <div id="loading-state" class="loader">
        <div class="spinner"></div>
        <p>Redirigiendo a la app...</p>
    </div>

    <!-- Estado de error (solo se muestra si hay error) -->
    <div id="error-state" class="error-message" style="display: none;">
        <h1>Error</h1>
        <p id="error-message-text"></p>
        <a id="error-app-link" href="#" style="display: none;">Abrir en la App</a>
    </div>

    <!-- Cargar script inmediatamente (antes de que termine de cargar el body) -->
    <script>
        // Código inline para redirección inmediata (más rápido)
        // Código inline para redirección inmediata (más rápido)
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const consultorioId = urlParams.get("consultorioId");
            const invitacionId = urlParams.get("invitacionId");
            const token = urlParams.get("token");
            
            function showError(message, showRetry = false, url = '#') {
                document.getElementById('loading-state').style.display = 'none';
                const errorState = document.getElementById('error-state');
                const errorText = document.getElementById('error-message-text');
                const errorLink = document.getElementById('error-app-link');
                
                errorState.style.display = 'block';
                errorText.textContent = message;
                
                if (showRetry) {
                    errorLink.href = url;
                    errorLink.style.display = 'inline-block';
                    errorLink.textContent = 'Intentar abrir App';
                }
            }

            if (consultorioId && (invitacionId || token)) {
                const APP_SCHEME = "densora://aceptar-invitacion";
                const APP_PACKAGE = "com.tekkure.densora";
                
                let appUrl = "";
                let androidIntent = "";
                
                if (token) {
                    appUrl = `${APP_SCHEME}?consultorioId=${consultorioId}&token=${token}`;
                    androidIntent = `intent://aceptar-invitacion?consultorioId=${consultorioId}&token=${token}#Intent;scheme=densora;package=${APP_PACKAGE};end`;
                } else if (invitacionId) {
                    appUrl = `${APP_SCHEME}?consultorioId=${consultorioId}&invitacionId=${invitacionId}`;
                    androidIntent = `intent://aceptar-invitacion?consultorioId=${consultorioId}&invitacionId=${invitacionId}#Intent;scheme=densora;package=${APP_PACKAGE};end`;
                }
                
                // Intentar redirigir inmediatamente
                const startTime = Date.now();
                
                if (navigator.userAgent.match(/Android/i)) {
                    window.location.href = androidIntent;
                } else {
                    window.location.href = appUrl;
                }

                // Fallback si no redirige después de unos segundos
                setTimeout(() => {
                    // Si la página sigue visible es porque probablemente no se abrió la app
                    if (document.visibilityState === 'visible') {
                        showError('Si la aplicación no se abrió automáticamente, por favor intenta usar el botón de abajo.', true, appUrl);
                    }
                }, 3000);

            } else {
                showError('El enlace de invitación está incompleto o es inválido. Por favor contacta al administrador.');
            }
        })();
    </script>
    <script src="aceptar-invitacion.js"></script>
</body>
</html>

